image: python:3.7-stretch

stages:
  - test
  - post

before_script:
  - pip3 install tox tox-venv

  - useradd -Um buildstream
  - chown -R buildstream:buildstream .

#####################################################
#                    Test stage                     #
#####################################################

tests:
  stage: test
  variables:
    PY_COLORS: 1
    TOXENV: py37
  script:
    - su buildstream -c 'tox -- --color=yes'

lint:
  stage: test
  variables:
    PY_COLORS: 1
    TOXENV: flake8
  script:
    - su buildstream -c 'tox'

docs:
  stage: test
  variables:
    PY_COLORS: 1
    TOXENV: docs
  script:
  - su buildstream -c 'tox'
  - mv doc/build/html public
  artifacts:
    paths:
    - public/

#####################################################
#                  Post stage                       #
#####################################################

pages:
  stage: post
  dependencies:
  - docs
  # XXX: This script section is really a no-op but we need to have it since
  # GitLab CI mandates that the pages script can't be blank.
  script:
  - find public/
  artifacts:
    paths:
    - public/
  only:
  - master
